<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Internet Radio</title>
  <style>
    /*----------------------------------------*/
    /* 1) Prevent all scrolling/overflow       */
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      touch-action: none;
      background-color: #311B0B;
      color: #fff;
      font-family: 'Segoe UI', Arial, sans-serif;
      box-sizing: border-box;
    }

    /*----------------------------------------*/
    /* 2) Blurred background image            */
    #bg-blur {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center;
      filter: blur(25px) brightness(0.7);
      pointer-events: none;
      z-index: 0;
      transition: opacity 0.5s ease;
    }

    /*----------------------------------------*/
    /* 3) Header + Safe-Area Handling         */
    #header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 56px;
      pointer-events: none;
      z-index: 2;
    }
    #logo {
      position: absolute;
      top: calc(16px + env(safe-area-inset-top));
      left: calc(16px + env(safe-area-inset-left));
      font-size: 1.5rem;
      font-weight: 600;
      letter-spacing: 2px;
      pointer-events: auto;
      user-select: none;
      color: #fff;
    }
    #menu-btn {
      position: absolute;
      top: calc(16px + env(safe-area-inset-top));
      right: calc(64px + env(safe-area-inset-right));
      font-size: 1.5rem;
      background: none;
      border: none;
      color: #fff;
      cursor: pointer;
      outline: none;
      pointer-events: auto;
      user-select: none;
    }
    #stats-btn {
      position: absolute;
      top: calc(16px + env(safe-area-inset-top));
      right: calc(16px + env(safe-area-inset-right));
      font-size: 1.2rem;
      background: none;
      border: none;
      color: #fff;
      cursor: pointer;
      outline: none;
      pointer-events: auto;
      user-select: none;
      padding: 4px;
    }

    /*----------------------------------------*/
    /* 4) Menu Popup (below the button)       */
    #menu-popup {
      display: none;
      position: absolute;
      top: calc(56px + env(safe-area-inset-top));
      right: calc(64px + env(safe-area-inset-right));
      min-width: 180px;
      background: rgba(255, 255, 255, 0.96);
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      padding: 12px 16px;
      font-size: 1rem;
      color: #222;
      max-width: calc(100vw - 32px);
      z-index: 1000;
      animation: fadeIn 0.2s ease-out;
    }
    #menu-popup.active {
      display: block;
    }
    #menu-popup h3 {
      margin: 0 0 8px;
      font-size: 1.1rem;
      font-weight: 600;
    }

    /*----------------------------------------*/
    /* 5) Settings & Stats Panel              */
    #stats-panel {
      position: fixed;
      top: 0;
      right: -400px;
      width: 350px;
      height: 100vh;
      background: rgba(0, 0, 0, 0.95);
      color: #fff;
      padding: 20px;
      box-sizing: border-box;
      z-index: 2000;
      overflow-y: auto;
      transition: right 0.3s ease;
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
      line-height: 1.4;
      backdrop-filter: blur(10px);
      border-left: 1px solid rgba(255, 255, 255, 0.1);
    }
    #stats-panel.active {
      right: 0;
    }
    #stats-panel h2 {
      margin: 0 0 20px;
      font-size: 1.2rem;
      color: #00ff00;
      text-align: center;
      border-bottom: 1px solid #333;
      padding-bottom: 10px;
    }
    .stat-group {
      margin-bottom: 20px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .stat-group h3 {
      margin: 0 0 10px;
      color: #ffff00;
      font-size: 1rem;
    }
    .stat-item {
      display: flex;
      justify-content: space-between;
      margin: 5px 0;
      padding: 2px 0;
    }
    .stat-label {
      color: #ccc;
      flex: 1;
    }
    .stat-value {
      color: #00ff88;
      font-weight: bold;
      text-align: right;
      flex: 1;
    }
    .stat-value.warning {
      color: #ffaa00;
    }
    .stat-value.error {
      color: #ff4444;
    }
    #close-stats {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      color: #fff;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 5px;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    #close-stats:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    /* Buffer mode selector */
    .buffer-selector {
      margin: 15px 0;
      padding: 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 6px;
    }
    .buffer-option {
      display: flex;
      align-items: center;
      margin: 8px 0;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .buffer-option:hover {
      opacity: 0.8;
    }
    .buffer-option input {
      margin-right: 8px;
    }
    .buffer-option label {
      cursor: pointer;
      flex: 1;
    }
    .buffer-desc {
      font-size: 0.75rem;
      color: #888;
      margin-left: 24px;
    }

    /*----------------------------------------*/
    /* 6) Main content (centered, below header) */
    #main-content {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      padding-top: calc(56px + env(safe-area-inset-top));
      padding-bottom: calc(80px + env(safe-area-inset-bottom));
      box-sizing: border-box;
      text-align: center;
      z-index: 1;
    }

    /* COVER CARD */
    #cover-card {
      background: rgba(0, 0, 0, 0.4);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 4px 32px rgba(0, 0, 0, 0.3);
      display: inline-flex;
      flex-direction: row;
      align-items: center;
      gap: 20px;
      max-width: calc(90vw - 32px);
      box-sizing: border-box;
    }
    #album-cover {
      width: clamp(160px, 30vw, 280px);
      height: clamp(160px, 30vw, 280px);
      background: #333;
      border-radius: 12px;
      box-shadow: 0 2px 14px rgba(0, 0, 0, 0.5);
      object-fit: cover;
      object-position: center;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ccc;
      font-size: 3rem;
      border: 3px solid #fff;
      overflow: hidden;
      position: relative;
    }
    #album-cover img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 12px;
      position: absolute;
      top: 0;
      left: 0;
      opacity: 0;
      transition: opacity 0.5s ease;
    }
    #album-cover img.visible {
      opacity: 1;
    }
    #details {
      display: flex;
      flex-direction: column;
      justify-content: center;
      color: #fff;
      text-align: left;
    }
    #song-title {
      font-size: clamp(1.5rem, 4vw, 2rem);
      font-weight: 700;
      margin: 0 0 8px;
      letter-spacing: 0.5px;
      line-height: 1.2;
    }
    #song-artist {
      font-size: clamp(1rem, 3vw, 1.2rem);
      font-weight: 400;
      margin: 0;
      opacity: 0.9;
    }

    /* Status indicator */
    #status-indicator {
      position: absolute;
      top: calc(70px + env(safe-area-inset-top));
      right: calc(16px + env(safe-area-inset-right));
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 500;
      background: rgba(0, 0, 0, 0.6);
      color: #fff;
      z-index: 3;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    #status-indicator.show {
      opacity: 1;
    }
    #status-indicator.buffering {
      background: rgba(255, 165, 0, 0.8);
      color: #000;
    }
    #status-indicator.error {
      background: rgba(255, 0, 0, 0.8);
    }
    #status-indicator.reconnecting {
      background: rgba(0, 150, 255, 0.8);
    }
    #status-indicator.connected {
      background: rgba(0, 255, 0, 0.8);
      color: #000;
    }

    /*----------------------------------------*/
    /* 7) Bottom controls                     */
    #controls {
      position: absolute;
      bottom: calc(16px + env(safe-area-inset-bottom));
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.6);
      border-radius: 32px;
      padding: 8px 16px;
      display: flex;
      align-items: center;
      gap: 16px;
      box-sizing: border-box;
      max-width: calc(100vw - 32px);
      z-index: 10;
    }
    #play-btn {
      width: clamp(40px, 8vw, 50px);
      height: clamp(40px, 8vw, 50px);
      background: #fff;
      border: none;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      transition: background 0.2s;
      padding: 0;
      flex-shrink: 0;
    }
    #play-btn:hover {
      background: #eee;
    }
    #play-btn svg {
      width: clamp(18px, 4vw, 24px);
      height: clamp(18px, 4vw, 24px);
      fill: #311B0B;
    }
    #volume-slider {
      -webkit-appearance: none;
      width: clamp(80px, 20vw, 180px);
      height: 4px;
      background: #fff;
      border-radius: 2px;
      outline: none;
      cursor: pointer;
      flex-shrink: 1;
    }
    #volume-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #311B0B;
      cursor: pointer;
      box-shadow: 0 1px 5px rgba(0, 0, 0, 0.3);
    }
    #volume-slider::-moz-range-thumb {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #311B0B;
      cursor: pointer;
      box-shadow: 0 1px 5px rgba(0, 0, 0, 0.3);
    }

    /*----------------------------------------*/
    /* 8) Portrait/mobile corrections          */
    @media only screen and (max-width: 600px) and (orientation: portrait) {
      #cover-card {
        flex-direction: column;
        align-items: center;
      }
      #details {
        text-align: center;
        margin-top: 12px;
      }
      #controls {
        gap: 12px;
        padding: 8px 16px;
      }
      #volume-slider {
        width: 120px;
      }
      #stats-panel {
        width: 100vw;
        right: -100vw;
        padding: 15px;
      }
    }

    @media only screen and (max-width: 900px) and (orientation: landscape) {
      #album-cover {
        width: clamp(80px, 15vw, 120px) !important;
        height: clamp(80px, 15vw, 120px) !important;
      }
      #cover-card {
        max-width: calc(100vw - 64px);
        padding: 12px 16px;
        gap: 16px;
      }
      #song-title {
        font-size: clamp(1.2rem, 3vw, 1.6rem);
        margin: 0 0 4px;
      }
      #song-artist {
        font-size: clamp(0.9rem, 2.5vw, 1.1rem);
      }
      #stats-panel {
        width: 280px;
        right: -280px;
        padding: 12px;
        font-size: 0.75rem;
      }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-8px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <!-- 1) Blurred background -->
  <img id="bg-blur" src="" alt="Background Cover">

  <!-- 2) Header -->
  <div id="header">
    <div id="logo">HaverokFM</div>
    <button id="menu-btn" aria-label="Open menu">&#9776;</button>
    <button id="stats-btn" aria-label="Show stats">üìä</button>
    <div id="menu-popup">
      <h3>About</h3>
      <p>This is an internet radio by haverok for haverok.<br>Made by Erik.</p>
    </div>
  </div>

  <!-- Settings & Stats Panel -->
  <div id="stats-panel">
    <button id="close-stats">√ó</button>
    <h2>‚öôÔ∏è SETTINGS & STATS</h2>
    
    <div class="stat-group">
      <h3>üéöÔ∏è Buffer Mode</h3>
      <div class="buffer-selector">
        <div class="buffer-option">
          <input type="radio" id="buffer-low" name="buffer" value="low">
          <label for="buffer-low">Low Latency (Live)</label>
        </div>
        <div class="buffer-desc">Minimal delay, needs good connection</div>
        
        <div class="buffer-option">
          <input type="radio" id="buffer-balanced" name="buffer" value="balanced" checked>
          <label for="buffer-balanced">Balanced (Auto)</label>
        </div>
        <div class="buffer-desc">Adapts to your connection</div>
        
        <div class="buffer-option">
          <input type="radio" id="buffer-stable" name="buffer" value="stable">
          <label for="buffer-stable">Stable (Buffered)</label>
        </div>
        <div class="buffer-desc">More delay but works on poor connections</div>
      </div>
    </div>
    
    <div class="stat-group">
      <h3>üìä Stream Stats</h3>
      <div class="stat-item">
        <span class="stat-label">Status:</span>
        <span class="stat-value" id="stream-status">Stopped</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Buffer:</span>
        <span class="stat-value" id="buffer-length">0.0s</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Position:</span>
        <span class="stat-value" id="audio-progress">0.0s</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Volume:</span>
        <span class="stat-value" id="volume-level">100%</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Reconnects:</span>
        <span class="stat-value" id="reconnect-count">0</span>
      </div>
    </div>
  </div>

  <!-- Status indicator -->
  <div id="status-indicator"></div>

  <!-- 3) Main content -->
  <div id="main-content">
    <div id="cover-card">
      <div id="album-cover">üìª</div>
      <div id="details">
        <div id="song-title"><b>Nincs duma (Csak zene)</b></div>
        <div id="song-artist">HaverokFM</div>
      </div>
    </div>
  </div>

  <!-- 4) Bottom controls -->
  <div id="controls">
    <button id="play-btn" aria-label="Play/Pause">
      <svg id="play-icon" viewBox="0 0 64 64">
        <polygon points="16,8 56,32 16,56"></polygon>
      </svg>
      <svg id="pause-icon" viewBox="0 0 64 64" style="display:none">
        <rect x="16" y="12" width="12" height="40"></rect>
        <rect x="36" y="12" width="12" height="40"></rect>
      </svg>
    </button>
    <input id="volume-slider" type="range" min="0" max="1" step="0.01" value="1">
    <audio id="audio" preload="auto"></audio>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const albumCoverEl = document.getElementById('album-cover');
      const bgBlurEl     = document.getElementById('bg-blur');
      const songTitleEl  = document.getElementById('song-title');
      const songArtistEl = document.getElementById('song-artist');
      const audio        = document.getElementById('audio');
      const playBtn      = document.getElementById('play-btn');
      const playIcon     = document.getElementById('play-icon');
      const pauseIcon    = document.getElementById('pause-icon');
      const volumeSlider = document.getElementById('volume-slider');
      const menuBtn      = document.getElementById('menu-btn');
      const menuPopup    = document.getElementById('menu-popup');
      const statusIndicator = document.getElementById('status-indicator');
      const statsBtn     = document.getElementById('stats-btn');
      const statsPanel   = document.getElementById('stats-panel');
      const closeStatsBtn = document.getElementById('close-stats');

      const coverUrl = "https://erik-server.ddns.net/image";
      const metaUrl  = "https://erik-server.ddns.net/metadata";
      const streamUrl = "https://erik-server.ddns.net/stream";
      
      // State
      let isPlaying = false;
      let reconnectCount = 0;
      let bufferMode = 'balanced';
      let reconnectTimer = null;
      let progressCheckInterval = null;
      let lastProgressTime = 0;
      let stallCount = 0;
      
      // Metadata
      let lastSongData = { title: '', artist: '' };
      let currentCoverUrl = '';

      // Buffer settings (in seconds)
      const bufferSettings = {
        low: { target: 0.5, max: 2, checkInterval: 3000 },
        balanced: { target: 3, max: 10, checkInterval: 5000 },
        stable: { target: 10, max: 30, checkInterval: 10000 }
      };

      // Initialize audio
      audio.src = streamUrl;
      audio.crossOrigin = "anonymous";
      audio.volume = volumeSlider.value;

      // Buffer mode handling
      document.querySelectorAll('input[name="buffer"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
          bufferMode = e.target.value;
          console.log('Buffer mode changed to:', bufferMode);
          
          // If playing, restart with new buffer settings
          if (isPlaying) {
            showStatus('Applying buffer settings...', 'buffering');
            restartStream();
          }
        });
      });

      function getBufferSettings() {
        return bufferSettings[bufferMode];
      }

      function showStatus(message, type = '') {
        statusIndicator.textContent = message;
        statusIndicator.className = `show ${type}`;
        setTimeout(() => {
          statusIndicator.classList.remove('show');
        }, 3000);
      }

      function updateStats() {
        document.getElementById('stream-status').textContent = isPlaying ? 'Playing' : 'Stopped';
        document.getElementById('volume-level').textContent = Math.round(audio.volume * 100) + '%';
        document.getElementById('audio-progress').textContent = audio.currentTime.toFixed(1) + 's';
        document.getElementById('reconnect-count').textContent = reconnectCount;
        
        if (audio.buffered.length > 0) {
          const bufferedEnd = audio.buffered.end(audio.buffered.length - 1);
          const bufferLength = bufferedEnd - audio.currentTime;
          document.getElementById('buffer-length').textContent = bufferLength.toFixed(1) + 's';
          
          // Color code buffer status
          const bufferEl = document.getElementById('buffer-length');
          const settings = getBufferSettings();
          if (bufferLength < settings.target) {
            bufferEl.className = 'stat-value warning';
          } else if (bufferLength > settings.max) {
            bufferEl.className = 'stat-value error';
          } else {
            bufferEl.className = 'stat-value';
          }
        } else {
          document.getElementById('buffer-length').textContent = '0.0s';
        }
      }

      function setAlbumCover(url) {
        // Only update if URL actually changed
        if (currentCoverUrl === url) return;
        currentCoverUrl = url;
        
        const img = new Image();
        img.crossOrigin = "anonymous";
        
        img.onload = () => {
          // Clear old images
          const existingImages = albumCoverEl.querySelectorAll('img');
          existingImages.forEach(oldImg => {
            oldImg.style.opacity = "0";
            setTimeout(() => oldImg.remove(), 500);
          });
          
          // Add new image
          const newImg = img.cloneNode();
          newImg.className = 'visible';
          albumCoverEl.appendChild(newImg);
          albumCoverEl.style.fontSize = '0';
          
          // Update background
          bgBlurEl.src = url;
          bgBlurEl.style.opacity = '1';
        };
        
        img.onerror = () => {
          albumCoverEl.innerHTML = 'üìª';
          albumCoverEl.style.fontSize = '3rem';
          bgBlurEl.style.opacity = '0';
        };
        
        img.src = url;
      }

      async function fetchMetadata() {
        try {
          const response = await fetch(metaUrl);
          const txt = await response.text();
          let song = "Unknown";
          let artist = "Unknown";

          // Parse metadata (same logic as before)
          try {
            const j = JSON.parse(txt);
            if (j.artist && j.title) {
              artist = j.artist;
              song = j.title;
            } else if (j.song) {
              const parts = j.song.split('#');
              if (parts.length === 2) {
                artist = parts[0];
                song = parts[1];
              }
            }
          } catch {
            if (txt.includes("#")) {
              const parts = txt.split("#");
              artist = parts[0].trim();
              song = parts[1].trim();
            }
          }

          // Check if song changed
          if (lastSongData.title !== song || lastSongData.artist !== artist) {
            lastSongData = { title: song, artist: artist };
            
            const displaySong = song.replace(/\s*\(/g, "<br>(");
            songTitleEl.innerHTML = `<b>${displaySong}</b>`;
            songArtistEl.textContent = artist;

            // Update cover with cache buster for new song
            setAlbumCover(coverUrl + '?t=' + Date.now());

            if ("mediaSession" in navigator) {
              navigator.mediaSession.metadata = new MediaMetadata({
                title: song,
                artist: artist,
                artwork: [{
                  src: currentCoverUrl,
                  sizes: '512x512',
                  type: 'image/png'
                }]
              });
            }
          }
        } catch (e) {
          console.error('Metadata fetch error:', e);
        }
      }

      function checkProgress() {
        if (!isPlaying || audio.paused) return;
        
        const currentTime = audio.currentTime;
        
        // Check if audio is progressing
        if (Math.abs(currentTime - lastProgressTime) < 0.1) {
          stallCount++;
          console.log('Audio stalled, count:', stallCount);
          
          // Only reconnect after multiple stalls
          if (stallCount > 3) {
            console.log('Multiple stalls detected, reconnecting...');
            reconnect();
            stallCount = 0;
          }
        } else {
          stallCount = 0;
        }
        
        lastProgressTime = currentTime;
        
        // Adjust buffer if needed
        const settings = getBufferSettings();
        if (audio.buffered.length > 0) {
          const bufferedEnd = audio.buffered.end(audio.buffered.length - 1);
          const bufferLength = bufferedEnd - audio.currentTime;
          
          // Jump forward if buffer too large (only in low latency mode)
          if (bufferMode === 'low' && bufferLength > settings.max) {
            audio.currentTime = bufferedEnd - settings.target;
            console.log('Jumped to live position');
          }
        }
      }

      function reconnect() {
        if (reconnectTimer) return; // Already reconnecting
        
        reconnectCount++;
        showStatus('Reconnecting...', 'reconnecting');
        
        // Clear existing stream
        audio.pause();
        audio.currentTime = 0;
        
        // Wait a bit then try again
        reconnectTimer = setTimeout(() => {
          audio.load();
          audio.play().then(() => {
            showStatus('Reconnected!', 'connected');
            console.log('Reconnect successful');
          }).catch(e => {
            console.error('Reconnect failed:', e);
            showStatus('Connection failed', 'error');
          });
          reconnectTimer = null;
        }, 2000);
      }

      function restartStream() {
        // Stop current stream
        if (progressCheckInterval) {
          clearInterval(progressCheckInterval);
        }
        
        audio.pause();
        audio.currentTime = 0;
        audio.load();
        
        // Start with new settings
        const settings = getBufferSettings();
        
        audio.play().then(() => {
          console.log('Stream restarted with buffer mode:', bufferMode);
          progressCheckInterval = setInterval(checkProgress, settings.checkInterval);
        }).catch(e => {
          console.error('Restart failed:', e);
        });
      }

      function togglePlay() {
        if (audio.paused) {
          // Start playing
          showStatus('Starting stream...', 'buffering');
          isPlaying = true;
          
          const settings = getBufferSettings();
          
          audio.play().then(() => {
            console.log('Playback started');
            showStatus('Connected', 'connected');
            
            // Start progress checking
            if (progressCheckInterval) {
              clearInterval(progressCheckInterval);
            }
            progressCheckInterval = setInterval(checkProgress, settings.checkInterval);
            
          }).catch(e => {
            console.error('Play failed:', e);
            showStatus('Failed to start', 'error');
            isPlaying = false;
          });
        } else {
          // Stop playing
          isPlaying = false;
          audio.pause();
          
          if (progressCheckInterval) {
            clearInterval(progressCheckInterval);
            progressCheckInterval = null;
          }
          
          console.log('Playback stopped');
        }
      }

      // Audio event listeners
      audio.addEventListener('play', () => {
        playIcon.style.display = 'none';
        pauseIcon.style.display = 'block';
        isPlaying = true;
        
        if ("mediaSession" in navigator) {
          navigator.mediaSession.playbackState = "playing";
        }
      });

      audio.addEventListener('pause', () => {
        playIcon.style.display = 'block';
        pauseIcon.style.display = 'none';
        isPlaying = false;
        
        if ("mediaSession" in navigator) {
          navigator.mediaSession.playbackState = "paused";
        }
      });

      audio.addEventListener('error', (e) => {
        console.error('Audio error:', e);
        if (isPlaying) {
          showStatus('Stream error', 'error');
          setTimeout(() => reconnect(), 2000);
        }
      });

      audio.addEventListener('waiting', () => {
        if (isPlaying) {
          showStatus('Buffering...', 'buffering');
        }
      });

      audio.addEventListener('canplay', () => {
        if (isPlaying) {
          showStatus('Ready', 'connected');
        }
      });

      audio.addEventListener('stalled', () => {
        console.log('Stream stalled');
        if (isPlaying) {
          stallCount++;
        }
      });

      // Control event listeners
      playBtn.addEventListener('click', togglePlay);
      
      volumeSlider.addEventListener('input', e => {
        audio.volume = parseFloat(e.target.value);
        updateStats();
      });

      // Stats panel controls
      statsBtn.addEventListener('click', e => {
        statsPanel.classList.toggle('active');
        e.stopPropagation();
      });
      
      closeStatsBtn.addEventListener('click', () => {
        statsPanel.classList.remove('active');
      });

      // Menu functionality
      menuBtn.addEventListener('click', e => {
        menuPopup.classList.toggle('active');
        statsPanel.classList.remove('active');
        e.stopPropagation();
      });
      
      // Close popups when clicking outside
      window.addEventListener('click', (e) => {
        if (!statsPanel.contains(e.target) && !statsBtn.contains(e.target)) {
          statsPanel.classList.remove('active');
        }
        if (!menuPopup.contains(e.target) && !menuBtn.contains(e.target)) {
          menuPopup.classList.remove('active');
        }
      });
      
      menuPopup.addEventListener('click', e => e.stopPropagation());
      statsPanel.addEventListener('click', e => e.stopPropagation());

      // Media Session handlers
      if ("mediaSession" in navigator) {
        navigator.mediaSession.setActionHandler('play', () => {
          if (audio.paused) {
            togglePlay();
          }
        });
        
        navigator.mediaSession.setActionHandler('pause', () => {
          if (!audio.paused) {
            togglePlay();
          }
        });
      }

      // Auto-start with user interaction fallback
      function tryAutoStart() {
        audio.play().then(() => {
          console.log('Auto-play successful');
          isPlaying = true;
          const settings = getBufferSettings();
          progressCheckInterval = setInterval(checkProgress, settings.checkInterval);
        }).catch(e => {
          console.log('Auto-play blocked, waiting for user interaction');
          
          // Setup one-time interaction handler
          const startOnInteraction = () => {
            if (!isPlaying) {
              togglePlay();
            }
            document.removeEventListener('click', startOnInteraction);
            document.removeEventListener('touchstart', startOnInteraction);
          };
          
          document.addEventListener('click', startOnInteraction);
          document.addEventListener('touchstart', startOnInteraction);
        });
      }

      // Initialize
      setAlbumCover(coverUrl);
      fetchMetadata();
      updateStats();
      
      // Try auto-start
      tryAutoStart();
      
      // Update intervals
      setInterval(fetchMetadata, 5000); // Check metadata every 5 seconds
      setInterval(updateStats, 1000);   // Update stats every second
    });
  </script>
</body>
</html>
